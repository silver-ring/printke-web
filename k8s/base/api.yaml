---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: printke-api
  namespace: printke
  labels:
    app: printke-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: printke-api
  template:
    metadata:
      labels:
        app: printke-api
    spec:
      containers:
        - name: api
          image: python:3.11-slim
          command: ["/bin/bash", "-c"]
          args:
            - |
              pip install fastapi uvicorn pydantic --quiet &&
              mkdir -p /app &&
              cat > /app/main.py << 'EOF'
              from fastapi import FastAPI
              from fastapi.middleware.cors import CORSMiddleware
              from fastapi.responses import JSONResponse
              import os

              app = FastAPI(
                  title="PrintKe API",
                  description="PrintKe Platform API",
                  version="1.0.0",
              )

              origins = os.getenv("CORS_ORIGINS", "http://localhost:3000").split(",")
              app.add_middleware(
                  CORSMiddleware,
                  allow_origins=origins,
                  allow_credentials=True,
                  allow_methods=["*"],
                  allow_headers=["*"],
              )

              @app.get("/health")
              async def health_check():
                  return JSONResponse(
                      content={"status": "healthy", "service": "printke-api", "version": "1.0.0", "platform": "kubernetes"},
                      status_code=200
                  )

              @app.get("/")
              async def root():
                  return {"message": "Welcome to PrintKe API on Kubernetes", "version": "1.0.0"}
              EOF
              uvicorn main:app --host 0.0.0.0 --port 8000 --app-dir /app
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: printke-config
            - secretRef:
                name: printke-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: printke-api
  namespace: printke
spec:
  selector:
    app: printke-api
  ports:
    - port: 8000
      targetPort: 8000
  type: ClusterIP
