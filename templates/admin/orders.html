{% extends "admin/base.html" %}

{% block title %}Orders{% endblock %}
{% block page_title %}Orders{% endblock %}

{% block topbar_actions %}
<div style="display: flex; gap: 10px;">
    <select id="statusFilter" class="form-input" style="width: auto;" onchange="loadOrders()">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="paid">Paid</option>
        <option value="processing">Processing</option>
        <option value="printing">Printing</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
    </select>
    <input type="text" id="searchInput" class="form-input" style="width: 250px;" placeholder="Search orders..." onkeyup="debounceSearch()">
</div>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Delivery</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTable">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px;">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let searchTimeout;
    let currentPage = 1;

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => loadOrders(), 300);
    }

    async function loadOrders(page = 1) {
        currentPage = page;
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value;

        let url = `/api/admin/orders?page=${page}`;
        if (status) url += `&status=${status}`;
        if (search) url += `&search=${encodeURIComponent(search)}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            const tbody = document.getElementById('ordersTable');

            if (data.orders && data.orders.length > 0) {
                tbody.innerHTML = data.orders.map(order => `
                    <tr>
                        <td>
                            <a href="/admin/orders/${order.order_number}" style="color: var(--primary); font-weight: 600;">
                                ${order.order_number}
                            </a>
                        </td>
                        <td>${order.customer || 'Guest'}</td>
                        <td>${order.phone || '-'}</td>
                        <td>${order.items_count}</td>
                        <td>KES ${order.total.toLocaleString()}</td>
                        <td><span class="badge badge-${order.status}">${order.status}</span></td>
                        <td><span class="badge badge-${order.payment_status}">${order.payment_status}</span></td>
                        <td>${order.delivery_method} (${order.delivery_city || '-'})</td>
                        <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        <td>
                            <a href="/admin/orders/${order.order_number}" class="btn btn-secondary btn-sm">View</a>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No orders found</td></tr>';
            }

            // Update pagination
            const pagination = document.getElementById('pagination');
            if (data.pagination && data.pagination.pages > 1) {
                let paginationHTML = '';
                for (let i = 1; i <= data.pagination.pages; i++) {
                    paginationHTML += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'} btn-sm" onclick="loadOrders(${i})">${i}</button>`;
                }
                pagination.innerHTML = paginationHTML;
            } else {
                pagination.innerHTML = '';
            }

        } catch (error) {
            console.error('Failed to load orders:', error);
            document.getElementById('ordersTable').innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">Error loading orders</td></tr>';
        }
    }

    loadOrders();
</script>
{% endblock %}
